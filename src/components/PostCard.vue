<template>
    <div class="g-4 p-1 mb-4 card elevation-3 ">
        <img :src="post.creatorPicture" class="btnclicky profile-pic" alt="">
        <h4 class="">{{ post.creatorName }}</h4>
        <p>{{ formatCreatedAt(post.createdAt) }}</p>
        <p>{{ post.body }}</p>
        <img class="post-image" :src="post.imgUrl" alt="">
        <i @click="postVote()" class="mdi mdi-laptop btnclicky">{{
            post.likes.length }}</i>
        <img :src="post.likeIds" class="img-fluid rounded-top" alt="">
        <i @click="deletePost()" class="mdi mdi-select-remove btnclicky"></i>
        <!-- TODO FIGURE OUT HWTO GET LIKE IDS TO DISPLAY NAME. -->

    </div>
</template>


<script>
import { ref, onMounted, computed } from 'vue';

import { Post } from '../models/Post.js';
import { useRouter } from 'vue-router';
import { Profile } from '../models/Profile.js';
import { logger } from '../utils/Logger.js';
import { postsService } from '../services/PostsService.js';
import Pop from '../utils/Pop.js';
import { AppState } from '../AppState';
import { inject } from 'vue';




export default {
    name: 'Profile-PostCard',

    props: {
        post: { type: Post, required: true },
        profile: { type: Profile, required: true }
    },
    methods: {
        formatCreatedAt(createdAt) {
            const createdAtDate = new Date(createdAt);
            const now = new Date();
            const timeDifference = now - createdAtDate;
            const hoursDifference = Math.floor(timeDifference / (1000 * 60 * 60));

            if (hoursDifference < 24) {
                return `${hoursDifference} hours ago`;
            } else {
                return createdAtDate.toLocaleDateString();
            }
        },
        async deletePost() {
            try {
                if (await Pop.confirm('Are you sure?')) {
                    const postId = this.post.id;
                    await postsService.removePost(postId);

                    const postIndex = AppState.posts.findIndex(post => post.id == postId);
                    if (postIndex !== -1) {
                        AppState.posts.splice(postIndex, 1);
                    }
                    Pop.toast('Post deleted successfully');
                }
            } catch (error) {
                Pop.error(error);
            }
        }
    },

    setup(props) {
        const appState = inject('AppState');
        const postData = ref(null);
        const router = useRouter(); // Initialize the router object

        onMounted(() => {
            // ...
        });

        return {
            AppState,
            postData,
            activePost: computed(() => AppState.activePost),
            account: computed(() => AppState.account),
            // goToProfileById,
            // async goToProfileById() {
            //     try {
            //         await router.push({ name: 'UserProfile', params: { id: props.profile.id } });
            //         logger.log('is this on?');
            //     } catch (error) {
            //         Pop.error(error);
            //     }
            // },

            async postVote() {
                try {
                    logger.log('this.post:', this.post);
                    const updatedPost = await postsService.postVote(props.post.id);
                    logger.log('updatedPost:', updatedPost);
                    props.post.likes = updatedPost;
                    Pop.toast('ðŸ¤–V0t3 1s C4st!ðŸ¤–');
                } catch (error) {
                    logger.error('Error in postVote:', error);
                    Pop.error(error);
                }
            },

        }
    }
    //  components: { PostForm }
};




</script>


<style scoped="scss">
.btnclicky:hover {
    cursor: pointer !important;
    ;
}

.profile-pic {
    height: 75px;
    width: 75px;
    object-fit: cover;
    object-position: center;
    border-radius: 50em;
}

.post-image {
    height: 75vh;
    width: 100%;
    object-fit: cover;
    object-position: center center;
}
</style>